# Operations Guide

**Running, monitoring, and troubleshooting Vipra Sethu**

**Last Updated:** 11-Nov-2025

---

## Auth URLs & Redirects

**Summary:** No hardcoded `localhost` in runtime auth code. Origins are resolved dynamically, so magic link/login flows work across local, preview, and production.

**Implementation details:**

- Login magic link
  - `app/login/page.tsx` uses `window.location.origin` to set `emailRedirectTo`:
    - `${window.location.origin}/auth/callback?next=...`
- Auth callback route
  - `app/auth/callback/route.ts` parses `origin` from `request.url` and validates `next` URL is same-origin before redirecting.
- Supabase config (local)
  - `supabase/config.toml` contains `site_url = "http://127.0.0.1:3000"` for local dev only; production and preview use Supabase Dashboard settings.
- Tests & docs
  - References to `http://localhost:3000` exist only in tests and documentation; not used at runtime.

**Operational notes:**

- Ensure Supabase Auth → URL Configuration includes the production domain and any Vercel preview wildcard as needed.
- No need to set a static site URL in code; dynamic origin handling supports multiple environments.

---

## Quick Reference

**Something broken?** Jump to [Common Incidents](#common-incidents)  
**Need to deploy?** See [Deployment](#deployment)  
**Looking for logs?** Check [Monitoring & Logs](#monitoring--logs)

---

## Table of Contents

1. [Environments](#environments)
2. [Deployment](#deployment)
3. [Health Checks](#health-checks)
4. [Monitoring & Logs](#monitoring--logs)
5. [Common Incidents](#common-incidents)
6. [Data & Backups](#data--backups)
7. [On-Call & Ownership](#on-call--ownership)

---

## Environments

### Local Development

**URL:** `http://localhost:3000`

**Purpose:** Your machine for development and testing. Database connects to Supabase cloud (shared dev project).

**How to run:**
```bash
cd apps/web
pnpm dev
```

**Environment variables:** `.env.local` (never commit this file)

---

### Preview (Pull Requests)

**URL:** Auto-generated by Vercel (e.g., `vipra-sethu-pr-42.vercel.app`)

**Purpose:** Test changes before merging to main. Each PR gets its own preview URL. Uses production Supabase database (be careful with data changes).

**How it works:** Vercel automatically deploys every push to a PR branch. Check PR comments for preview URL.

**When to use:** Share with team for review, test on mobile devices, verify UI changes.

---

### Production

**URL:** `vipra-sethu.vercel.app` (or custom domain when configured)

**Purpose:** Live site that real users access. Connected to production Supabase project.

**How it works:** Automatic deployment when code is merged to `main` branch. Takes 2-3 minutes to build and deploy.

**Critical:** Never test experimental features directly in production. Always use preview deployments first.

---

## Deployment

### Automatic Deployment (Recommended)

**When:** Every push to `main` branch triggers automatic deployment to production.

**Steps:**
1. Merge PR to `main` branch on GitHub
2. Vercel detects the merge and starts building
3. Wait 2-3 minutes for build to complete
4. Vercel automatically deploys to production
5. Verify deployment (see [Health Checks](#health-checks))

**Where to watch:** Vercel dashboard → Deployments tab shows build progress and logs.

---

### Manual Deployment (Emergency)

**When:** Need to redeploy without code changes (e.g., environment variable update).

**Steps:**
1. Go to Vercel dashboard → Deployments
2. Find the latest successful deployment
3. Click three dots (•••) → Redeploy
4. Select "Use existing Build Cache" for faster deploy
5. Click "Redeploy" button
6. Wait 1-2 minutes, then verify

**Note:** This redeploys the same code. For new code changes, push to `main` instead.

---

### Verifying a Deployment

**After any deployment, check these 3 things:**

1. **Homepage loads**
   - Visit production URL
   - Should see hero section and navigation
   - Check browser console for errors (F12)

2. **Provider search works**
   - Go to `/providers` page
   - Try filtering by category
   - At least one provider should appear (if database has data)

3. **Check Vercel deployment status**
   - Vercel dashboard → Deployments
   - Latest deployment should show "Ready" with green checkmark
   - Click deployment to see build logs if anything failed

**If any of these fail, see [Common Incidents](#common-incidents).**

---

## Health Checks

### Quick Smoke Tests (5 minutes)

Run these manually after every production deployment:

**1. Homepage Check**
- [ ] Visit homepage
- [ ] Navigation menu appears
- [ ] No console errors (F12 → Console tab)

**2. Provider Directory**
- [ ] Visit `/providers` page
- [ ] Provider cards display (if data exists)
- [ ] Filters are visible (category, language, location)
- [ ] Click a provider card → detail page loads

**3. Search & Filter**
- [ ] Select a category from dropdown
- [ ] Results update (or show "no results" if none match)
- [ ] Clear filter → all providers show again

**4. Onboarding Form**
- [ ] Visit `/onboard` page
- [ ] Form loads with all fields
- [ ] Try submitting empty form → validation errors appear
- [ ] Don't submit real data (just test validation)

**5. Admin Dashboard** (if you have admin access)
- [ ] Visit `/admin` page
- [ ] Login redirects to magic link flow
- [ ] After login, pending providers list appears

---

### Automated Health Check (Future)

**Not implemented yet.** When we add it:
- Vercel cron job hits `/api/health` every 5 minutes
- Returns 200 if database is reachable
- Sends alert if down for >10 minutes

---

## Monitoring & Logs

### Where to Look When Things Break

**1. Vercel Logs (Deployment & Runtime Errors)**

**When to check:** Build failures, 500 errors, function timeouts

**How to access:**
1. Go to [Vercel Dashboard](https://vercel.com/dashboard)
2. Select `vipra-sethu` project
3. Click "Logs" tab
4. Filter by:
   - **Build logs:** See why deployment failed
   - **Function logs:** See server-side errors (Server Actions, API routes)
   - **Edge logs:** See middleware errors

**What to look for:**
- Red error messages
- Stack traces with file names and line numbers
- "Module not found" = missing dependency
- "Environment variable not found" = missing env var

---

**2. Browser Console (Client-Side Errors)**

**When to check:** UI not loading, buttons not working, forms not submitting

**How to access:**
1. Open the page with the issue
2. Press F12 (or right-click → Inspect)
3. Click "Console" tab
4. Look for red error messages

**What to look for:**
- `Uncaught TypeError` = JavaScript error in our code
- `Failed to fetch` = API call failed (check network tab)
- `Hydration error` = Server/client HTML mismatch (Next.js issue)
- `CORS error` = Supabase URL or key misconfigured

---

**3. Supabase Logs (Database & Auth Errors)**

**When to check:** Login not working, data not saving, RLS errors

**How to access:**
1. Go to [Supabase Dashboard](https://supabase.com/dashboard)
2. Select `vipra-sethu` project
3. Click "Logs" in sidebar
4. Choose log type:
   - **Postgres logs:** Database queries and errors
   - **Auth logs:** Login attempts and failures
   - **Storage logs:** Photo upload issues

**What to look for:**
- `permission denied` = RLS policy blocking access
- `duplicate key value` = Trying to insert existing record
- `relation does not exist` = Table or column name wrong
- `invalid input syntax` = Data type mismatch

---

**4. PostHog (User Analytics)**

**When to check:** Want to see how users are using the app

**How to access:**
1. Go to [PostHog Dashboard](https://app.posthog.com)
2. Select `vipra-sethu` project
3. Check:
   - **Events:** See search, view, contact events
   - **Funnels:** Onboarding completion rate
   - **Session recordings:** Watch user sessions (if enabled)

**What to look for:**
- Drop-offs in onboarding funnel = UX issue
- Low contact rate = Providers not appealing
- High bounce rate on search = Results not relevant

---

**5. Sentry (Error Tracking)**

**When to check:** Want to see all errors in one place (when configured)

**How to access:**
1. Go to [Sentry Dashboard](https://sentry.io)
2. Select `vipra-sethu` project
3. See errors grouped by type with stack traces

**What to look for:**
- Frequency of errors (1 vs 100 occurrences)
- Affected users (how many people hit this?)
- Stack trace to find exact line of code

---

## Common Incidents

### Incident 1: "Search is broken / No results showing"

**Symptoms:** Users can't find providers, search returns empty even with data in database.

**Quick checks:**
1. **Check if database has data**
   - Go to Supabase → Table Editor → `providers`
   - Verify there are rows with `status = 'approved'`
   - If empty, no providers have been approved yet (expected for new deployment)

2. **Check RLS policies**
   - Go to Supabase → Authentication → Policies
   - Verify "Public read approved" policy exists on `providers` table
   - Policy should be: `status = 'approved'`

3. **Check search RPC function**
   - Go to Supabase → SQL Editor
   - Run: `SELECT * FROM search_providers(NULL, NULL, NULL, NULL, NULL, NULL, NULL);`
   - Should return approved providers
   - If error, check function exists: `SELECT * FROM pg_proc WHERE proname = 'search_providers';`

**Fix:**
- **If no data:** Approve some providers via admin dashboard
- **If RLS issue:** Re-run `infra/supabase/02_policies.sql`
- **If RPC missing:** Re-run `infra/supabase/04_rpc_search.sql` and `07_clean_rpc_and_views.sql`

---

### Incident 2: "RLS denying users / Permission denied errors"

**Symptoms:** Users see "permission denied" errors, can't view providers, can't submit onboarding form.

**Quick checks:**
1. **Check browser console for exact error**
   - F12 → Console
   - Look for `new row violates row-level security policy` or `permission denied for table`

2. **Verify RLS policies exist**
   - Supabase → Table Editor → Click table → Policies tab
   - Each table should have at least one policy
   - `providers` needs: "Public read approved", "Users insert own"

3. **Check if user is authenticated (for insert errors)**
   - If onboarding fails, user might not be logged in
   - Check: `SELECT auth.uid();` in SQL Editor (should return UUID, not null)

**Fix:**
- **Missing policies:** Re-run `infra/supabase/02_policies.sql`
- **User not authenticated:** Redirect to `/login` before onboarding
- **Wrong policy logic:** Update policy in Supabase dashboard or SQL

---

### Incident 3: "Environment variable missing / undefined"

**Symptoms:** Build fails with "NEXT_PUBLIC_SUPABASE_URL is not defined", app crashes on startup.

**Quick checks:**
1. **Check Vercel environment variables**
   - Vercel Dashboard → Project Settings → Environment Variables
   - Verify all required vars exist:
     - `NEXT_PUBLIC_SUPABASE_URL`
     - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
     - `SUPABASE_SERVICE_ROLE_KEY`
     - `NEXT_PUBLIC_POSTHOG_KEY` (optional)
     - `NEXT_PUBLIC_SENTRY_DSN` (optional)

2. **Check variable scope**
   - Each var should be enabled for: Production, Preview, Development
   - If only enabled for Production, preview deployments will fail

3. **Check for typos**
   - Variable names are case-sensitive
   - Must match exactly what's in `.env.example`

**Fix:**
1. Add missing variable in Vercel dashboard
2. Click "Redeploy" on latest deployment
3. Verify deployment succeeds

**For local development:**
- Copy `.env.example` to `.env.local`
- Fill in all values
- Restart dev server: `pnpm dev`

---

### Incident 4: "Photos not displaying / 404 on images"

**Symptoms:** Provider photos show broken image icon, 404 errors in console.

**Quick checks:**
1. **Check if photos exist in storage**
   - Supabase → Storage → `provider-photos` bucket
   - Verify files are uploaded

2. **Check signed URL generation**
   - Look for errors in Vercel function logs
   - Search for "createSignedUrl" errors
   - Common issue: Service role key not set or wrong

3. **Check storage policies**
   - Supabase → Storage → `provider-photos` → Policies
   - Should have policy allowing service role to read
   - Public access should be disabled (private bucket)

**Fix:**
- **Missing service role key:** Add `SUPABASE_SERVICE_ROLE_KEY` to Vercel env vars
- **Wrong bucket name:** Check `lib/storage.ts` uses correct bucket name
- **Expired URLs:** Signed URLs expire after 15 minutes (this is normal, page refresh regenerates)

---

### Incident 5: "Admin can't login / Not authorized"

**Symptoms:** Admin tries to access `/admin` but gets redirected or sees "Not authorized".

**Quick checks:**
1. **Check if email is in admins table**
   - Supabase → Table Editor → `admins`
   - Verify admin's email exists in table
   - Email must match exactly (case-sensitive)

2. **Check if user is authenticated**
   - Have admin visit `/login` first
   - Click magic link in email
   - Then try `/admin` again

3. **Check middleware logic**
   - Look at `middleware.ts` file
   - Verify it checks `admins` table correctly

**Fix:**
- **Email not in table:** Add admin email to `admins` table manually
- **Not authenticated:** Admin must login first via magic link
- **Middleware broken:** Check Vercel function logs for errors

---

### Incident 6: "Onboarding form not submitting"

**Symptoms:** User fills form, clicks submit, nothing happens or shows error.

**Quick checks:**
1. **Check browser console**
   - F12 → Console
   - Look for validation errors or network errors

2. **Check network tab**
   - F12 → Network tab
   - Click submit again
   - Look for failed requests (red)
   - Click failed request → Preview tab to see error message

3. **Check Vercel function logs**
   - Search for Server Action errors
   - Look for validation failures or database errors

**Fix:**
- **Validation error:** Fix form fields (phone format, required fields)
- **Database error:** Check Supabase logs for RLS or constraint violations
- **Network error:** Check if Supabase is down (status.supabase.com)

---

### Incident 7: "Deployment failed / Build error"

**Symptoms:** Vercel deployment shows red X, build logs show errors.

**Quick checks:**
1. **Read the error message**
   - Vercel → Deployments → Click failed deployment
   - Scroll to first red error in logs
   - Common errors:
     - `Module not found` = Missing dependency
     - `Type error` = TypeScript compilation failed
     - `Build failed` = Next.js build error

2. **Check if it builds locally**
   - Run `pnpm build` in your terminal
   - If it fails locally, fix the error
   - If it works locally, might be env var issue

3. **Check recent commits**
   - What changed since last successful deploy?
   - Revert the breaking commit if needed

**Fix:**
- **Missing dependency:** Run `pnpm add <package>` and commit
- **TypeScript error:** Fix type errors in code
- **Environment variable:** Add missing var in Vercel dashboard
- **Emergency:** Revert to last working commit: `git revert <commit-hash>`

---

### Incident 8: "Database migration failed"

**Symptoms:** Ran SQL migration in Supabase, now queries fail or data is missing.

**Quick checks:**
1. **Check Supabase SQL Editor for errors**
   - Red error message shows what went wrong
   - Common: syntax error, table already exists, column doesn't exist

2. **Check if migration was partially applied**
   - Some statements might have succeeded before error
   - Use `\d table_name` to see table structure

3. **Check if data was lost**
   - Run `SELECT count(*) FROM providers;`
   - Compare to expected count

**Fix:**
- **Syntax error:** Fix SQL and re-run
- **Partial migration:** Manually complete remaining steps
- **Data loss:** Restore from backup (see [Data & Backups](#data--backups))
- **Prevention:** Always test migrations on local/dev first, never run untested SQL in production

---

## Data & Backups

### Automatic Backups (Supabase)

**What's backed up:** Entire PostgreSQL database (all tables, data, functions, policies)

**Frequency:** 
- **Free tier:** Daily backups, kept for 7 days
- **Pro tier:** Daily backups, kept for 30 days, plus point-in-time recovery

**How to restore:**
1. Go to Supabase → Database → Backups
2. Select backup date
3. Click "Restore"
4. Confirm (this will overwrite current database)

**When to restore:**
- Accidentally deleted important data
- Bad migration corrupted database
- Need to recover to specific point in time

**Warning:** Restoring overwrites ALL current data. Export current state first if needed.

---

### Manual Backups (Before Risky Changes)

**When to do it:**
- Before running database migrations
- Before bulk data updates
- Before testing new features in production

**How to backup:**

**Option 1: Export via Supabase Dashboard**
1. Supabase → Table Editor
2. Select table → Export → CSV
3. Save file locally
4. Repeat for each important table

**Option 2: pg_dump (Full Database)**
```bash
# Get connection string from Supabase → Project Settings → Database
pg_dump "postgresql://..." > backup_2025-11-08.sql
```

**How to restore from manual backup:**
```bash
# Restore from SQL dump
psql "postgresql://..." < backup_2025-11-08.sql
```

---

### Storage Backups (Photos)

**What's backed up:** Provider photos in `provider-photos` bucket

**Frequency:** Supabase Storage has automatic backups (same as database)

**How to manually backup:**
1. Supabase → Storage → `provider-photos`
2. Download all files (no bulk download in UI, use API)
3. Or use Supabase CLI: `supabase storage download`

**Recovery:** Re-upload files to storage bucket

---

### Data Safety Best Practices

**1. Never delete data directly in production**
- Use soft deletes (set `deleted_at` timestamp)
- Or change status to `archived` instead of DELETE

**2. Test migrations on preview first**
- Create PR with migration
- Run on preview environment
- Verify it works before merging to main

**3. Keep local backups before big changes**
- Export critical tables to CSV
- Store in `backups/` folder (gitignored)

**4. Document all manual data changes**
- Keep a log of when you ran SQL manually
- Note what you changed and why

---

## On-Call & Ownership

### Who to Contact

**For production issues:**
- **Primary:** Development Team Lead (check team roster)
- **Backup:** Any team member with admin access

**For Supabase issues:**
- Check [Supabase Status](https://status.supabase.com)
- If platform-wide outage, wait for Supabase to resolve
- If project-specific, contact Supabase support

**For Vercel issues:**
- Check [Vercel Status](https://www.vercel-status.com)
- If deployment issues, check Vercel dashboard first
- Contact Vercel support if platform issue

---

### Escalation Path

**Severity Levels:**

**P0 - Critical (Site Down)**
- Production site completely inaccessible
- All users affected
- **Response time:** Immediate
- **Action:** Page on-call engineer, start incident response

**P1 - High (Major Feature Broken)**
- Search not working, onboarding broken, admin dashboard down
- Many users affected
- **Response time:** Within 1 hour
- **Action:** Notify team, investigate immediately

**P2 - Medium (Minor Feature Broken)**
- Photos not loading, filters not working, slow performance
- Some users affected
- **Response time:** Within 4 hours
- **Action:** Create GitHub issue, fix in next sprint

**P3 - Low (Cosmetic Issue)**
- Styling broken, typos, minor UI glitches
- Few users affected
- **Response time:** Within 1 week
- **Action:** Create GitHub issue, prioritize in backlog

---

### Incident Response Checklist

**When production breaks:**

1. **Assess severity** (P0/P1/P2/P3)
2. **Notify team** (Slack/Discord/WhatsApp)
3. **Check status pages** (Vercel, Supabase)
4. **Check recent changes** (last deployment, recent commits)
5. **Look at logs** (Vercel, Supabase, Sentry)
6. **Try quick fix** (revert commit, redeploy, fix env var)
7. **Document incident** (what happened, what fixed it)
8. **Post-mortem** (how to prevent next time)

---

### Regular Maintenance Tasks

**Weekly:**
- [ ] Check Vercel deployment status (all green?)
- [ ] Review Sentry errors (any new patterns?)
- [ ] Check PostHog analytics (traffic normal?)
- [ ] Scan Supabase logs for errors

**Monthly:**
- [ ] Review and approve pending providers
- [ ] Check database size (approaching limits?)
- [ ] Review environment variables (any expired keys?)
- [ ] Update dependencies (`pnpm update`)

**Quarterly:**
- [ ] Review and update documentation
- [ ] Audit admin access (remove old admins)
- [ ] Review backup strategy
- [ ] Plan capacity upgrades if needed

---

## Quick Command Reference

### Vercel CLI

```bash
# Install Vercel CLI
pnpm add -g vercel

# Login to Vercel
vercel login

# Deploy to preview
vercel

# Deploy to production
vercel --prod

# View logs
vercel logs

# List deployments
vercel ls
```

---

### Supabase CLI

```bash
# Install Supabase CLI
pnpm add -g supabase

# Login to Supabase
supabase login

# Link to project
supabase link --project-ref <project-id>

# Run migration
supabase db push

# Generate TypeScript types
supabase gen types typescript --local > types/supabase.ts
```

---

### Database Quick Queries

```sql
-- Check approved providers count
SELECT count(*) FROM providers WHERE status = 'approved';

-- Check pending providers
SELECT name, email, created_at FROM providers WHERE status = 'pending';

-- Check admin list
SELECT email, created_at FROM admins;

-- Check recent admin actions
SELECT * FROM admin_actions ORDER BY created_at DESC LIMIT 10;

-- Check storage usage
SELECT pg_size_pretty(pg_database_size(current_database()));

-- Check RLS policies
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual
FROM pg_policies WHERE tablename = 'providers';
```

---

## Monitoring Dashboards

### PostHog Dashboard

**Key Metrics to Watch:**
- **Daily Active Users (DAU):** How many people use the app daily
- **Search Events:** How often people search for providers
- **Contact Events:** How often people click WhatsApp/phone
- **Onboarding Funnel:** What % complete provider registration

**Access:** [PostHog Dashboard](https://app.posthog.com)

---

### Vercel Analytics

**Key Metrics to Watch:**
- **Core Web Vitals:** LCP, FID, CLS (should be green)
- **Page Load Time:** <2 seconds for homepage
- **Error Rate:** <1% of requests
- **Traffic:** Unique visitors per day

**Access:** Vercel Dashboard → Analytics tab

---

### Sentry (When Configured)

**Key Metrics to Watch:**
- **Error Rate:** Errors per hour
- **Affected Users:** How many users hit errors
- **Top Errors:** Most frequent error types
- **Performance:** Slow transactions

**Access:** [Sentry Dashboard](https://sentry.io)

---

## Emergency Contacts

**Supabase Support:** support@supabase.io  
**Vercel Support:** support@vercel.com  
**Team Lead:** [Add contact info]  
**On-Call Rotation:** [Add schedule link]

---

**Last Updated:** 08-Nov-2025  
**Next Review:** Monthly  
**Owner:** Development Team

---

**Remember:** When in doubt, check logs first. Most issues show clear error messages if you know where to look. Don't panic, follow the runbooks, and document what you learn.
